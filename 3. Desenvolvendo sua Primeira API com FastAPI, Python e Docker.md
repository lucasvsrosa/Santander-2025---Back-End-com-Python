Passo a Passo para Implementar os Requisitos
1. Configuração do Ambiente

Antes de tudo, vamos garantir que seu ambiente esteja configurado. Aqui está o básico:

FastAPI para construir a API.

SQLAlchemy para interagir com o banco de dados.

Docker para containerizar a aplicação.

fastapi-pagination para implementar a paginação.

Se você ainda não tem, instale as dependências:

pip install fastapi sqlalchemy uvicorn psycopg2 fastapi-pagination


Para rodar o servidor de desenvolvimento, você pode usar o Uvicorn:

uvicorn main:app --reload

2. Criando o Banco de Dados com SQLAlchemy

Aqui está um exemplo de como você pode configurar o modelo de dados para o "atleta":

from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "postgresql://username:password@localhost/dbname"  # Modifique conforme necessário

engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()

class Atleta(Base):
    __tablename__ = "atletas"
    
    id = Column(Integer, primary_key=True, index=True)
    nome = Column(String, index=True)
    cpf = Column(String, unique=True, index=True)
    centro_treinamento = Column(String)
    categoria = Column(String)

Base.metadata.create_all(bind=engine)

3. Adicionando Endpoints com Query Parameters

Agora, podemos definir os endpoints para adicionar e listar atletas.

Endpoint para Adicionar Atleta
from fastapi import FastAPI, HTTPException
from sqlalchemy.orm import Session
from pydantic import BaseModel
import sqlalchemy.exc

app = FastAPI()

class AtletaCreate(BaseModel):
    nome: str
    cpf: str
    centro_treinamento: str
    categoria: str

@app.post("/atletas/")
def create_atleta(atleta: AtletaCreate, db: Session = Depends(get_db)):
    db_atleta = db.query(Atleta).filter(Atleta.cpf == atleta.cpf).first()
    if db_atleta:
        raise HTTPException(status_code=303, detail=f"Já existe um atleta cadastrado com o cpf: {atleta.cpf}")
    
    db_atleta = Atleta(**atleta.dict())
    db.add(db_atleta)
    db.commit()
    db.refresh(db_atleta)
    return db_atleta

Endpoint para Listar Atletas com Query Parameters

Aqui, você pode adicionar query parameters como nome ou cpf para filtrar os resultados.

from fastapi import Query

@app.get("/atletas/")
def get_atletas(nome: str = None, cpf: str = None, db: Session = Depends(get_db)):
    query = db.query(Atleta)
    
    if nome:
        query = query.filter(Atleta.nome.ilike(f"%{nome}%"))
    if cpf:
        query = query.filter(Atleta.cpf == cpf)
    
    atletas = query.all()
    return atletas

4. Customizando a Resposta

No endpoint get_atletas, podemos personalizar a resposta para incluir apenas os campos desejados.

@app.get("/atletas/")
def get_atletas(nome: str = None, cpf: str = None, db: Session = Depends(get_db)):
    query = db.query(Atleta)
    
    if nome:
        query = query.filter(Atleta.nome.ilike(f"%{nome}%"))
    if cpf:
        query = query.filter(Atleta.cpf == cpf)
    
    atletas = query.all()
    
    return [{"nome": atleta.nome, "centro_treinamento": atleta.centro_treinamento, "categoria": atleta.categoria} for atleta in atletas]

5. Paginação com fastapi-pagination

Para implementar a paginação com a biblioteca fastapi-pagination, basta integrar a função paginate nos seus endpoints.

Primeiro, instale a biblioteca:

pip install fastapi-pagination


Depois, adicione a paginação aos seus endpoints:

from fastapi_pagination import Page, paginate

@app.get("/atletas/", response_model=Page[Atleta])
def get_atletas(nome: str = None, cpf: str = None, db: Session = Depends(get_db)):
    query = db.query(Atleta)
    
    if nome:
        query = query.filter(Atleta.nome.ilike(f"%{nome}%"))
    if cpf:
        query = query.filter(Atleta.cpf == cpf)
    
    return paginate(query)


A função paginate() se encarrega de dividir os resultados com base nos parâmetros limit e offset que são passados automaticamente via query string. Exemplo de requisição:

GET /atletas/?limit=10&offset=0

6. Tratamento de Exceções

Já implementamos a verificação de integridade de dados no exemplo de criação do atleta, com o código:

if db_atleta:
    raise HTTPException(status_code=303, detail=f"Já existe um atleta cadastrado com o cpf: {atleta.cpf}")


Essa é uma boa forma de manipular exceções, mas você pode expandir para lidar com mais tipos de erros se necessário.

7. Dockerizando a Aplicação

Para rodar a API dentro de um container Docker, crie um Dockerfile:

# Use uma imagem base do Python
FROM python:3.9-slim

# Defina o diretório de trabalho
WORKDIR /app

# Copie os arquivos necessários
COPY requirements.txt .

# Instale as dependências
RUN pip install --no-cache-dir -r requirements.txt

# Copie o código da aplicação
COPY . .

# Defina o comando para rodar a API
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]


Crie o arquivo requirements.txt com as dependências:

fastapi
sqlalchemy
psycopg2
uvicorn
fastapi-pagination


Agora, construa e rode o Docker container:
